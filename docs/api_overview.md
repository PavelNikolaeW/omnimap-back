# OmniMap API

Документ описывает основные REST-эндпоинты проекта OmniMap. Все URL построены
относительно базового префикса `/api/v1/`.

## Базовые принципы
- **Формат данных:** все запросы и ответы используют JSON.
- **Аутентификация:** защищённые эндпоинты ожидают заголовок
  `Authorization: Bearer <JWT>`. JWT-токены выдаёт SimpleJWT.
- **Права доступа:** многие операции требуют определённых прав на блок. Если
  проверка не пройдена, API вернёт `403 Forbidden`.

## Аутентификация и пользователи
| Метод | URL | Описание |
|-------|-----|----------|
| `POST` | `/api/v1/register/` | Регистрирует пользователя и создаёт личный корневой блок. В ответе возвращаются пары токенов и идентификаторы пользователя/блока. |
| `POST` | `/api/v1/login/` | Получает пару JWT токенов (access/refresh). Требует `username` и `password`. |
| `POST` | `/api/v1/token/refresh/` | Обновляет access-токен по refresh-токену. |
| `POST` | `/api/v1/token/verify/` | Проверяет валидность access- или refresh-токена. |
| `GET` | `/api/v1/users/` | Возвращает список пользователей с пагинацией. **Только для администраторов** (`is_staff=true`). Параметры: `page`, `page_size` (макс. 200). |

## Работа с блоками и деревьями
| Метод | URL | Краткое описание | Важные параметры |
|-------|-----|------------------|------------------|
| `GET` | `/api/v1/load-trees/` | Загружает все доступные пользователю корневые деревья целиком. | Авторизованный пользователь определяется автоматически; для неавторизованных используется пользователь `main_page`. |
| `POST` | `/api/v1/load-empty/` | Возвращает «плоские» данные по указанным `block_ids` (список UUID). | Тело: `{ "block_ids": ["<uuid>", ...] }`. |
| `POST` | `/api/v1/new-tree/` | Создаёт новое корневое дерево (блок без родителя). | Тело: `{ "title": "Название" }`. |
| `POST` | `/api/v1/new-block/<parent_id>/` | Создаёт дочерний блок и наследует права родителя. | Тело: `{ "title": "...", "data": { ... } }`. Возвращает обновлённые данные дочернего и родительского блоков. |
| `POST` | `/api/v1/create-link-block/<parent_id>/<source_id>/` | Создаёт «линковый» блок, указывающий на существующий блок. | Тело пустое. В ответе — данные родителя, исходного блока и новой ссылки. |
| `POST` | `/api/v1/move-block/<old_parent_id>/<new_parent_id>/<child_id>/` | Перемещает блок в другое место дерева и обновляет порядок дочерних элементов. | Тело: `{ "childOrder": ["<uuid>", ...] }`. |
| `POST` | `/api/v1/edit-block/<block_id>/` | Обновляет заголовок и данные блока. | Тело может содержать `title` и/или `data` (должен быть объектом). Поле `source` в данных игнорируется. |
| `DELETE` | `/api/v1/delete-tree/<tree_id>/` | Удаляет дерево блоков целиком (учитываются права и наличие ссылок). | Без тела. Ответ содержит обновлённые данные родителя. |
| `DELETE` | `/api/v1/delete-tree-force/<tree_id>/` | Удаляет блок или дерево даже при наличии ссылок, переназначая их на служебный блок. | Требует права `delete`. |
| `POST` | `/api/v1/copy-block/` | Копирует одно или несколько поддеревьев в указанный блок-назначение. | Тело: `{ "dest": "<uuid>", "src": ["<uuid>", ...] }`. В ответе возвращается словарь новых блоков и ID их копий. |
| `POST` | `/api/v1/import/` | Массово создаёт/обновляет блоки. | См. подробное описание структуры ниже. |
| `POST` | `/api/v1/export/` | Экспортирует блоки в формате, совместимом с import. | Тело: `{ "block_ids": ["<uuid>", ...], "include_children": true, "max_depth": 10, "include_permissions": false }`. См. описание ниже. |
| `GET` | `/api/v1/search-block/` | Поиск блоков, к которым у пользователя есть доступ. | Параметры: `q` (строка поиска), `root` (UUID корня для ограничения), `everywhere=true` для глобального поиска. Результат пагинирован (`page`, `page_size`). |

## Права доступа
| Метод | URL | Описание |
|-------|-----|----------|
| `GET` | `/api/v1/access/<block_id>/` | Возвращает список пользователей и групп с правами на блок. Требует права `edit_ac` или `delete`. |
| `POST` | `/api/v1/access/<block_id>/` | Запускает асинхронное обновление прав. Тело: `{"permission_type": "<perm>", "target_username": "user"}` или `{"permission_type": "<perm>", "group_name": "group"}`. Ответ содержит `task_id`. |
| `GET` | `/api/v1/tasks/<task_id>/` | Проверяет статус Celery-задачи. Возвращает только задачи, созданные текущим пользователем. Ответ: `{ "task_id": ..., "status": "PENDING|SUCCESS|...", "result": ... }`. |

## Общие ссылки (публичный доступ)
| Метод | URL | Описание |
|-------|-----|----------|
| `POST` | `/api/v1/create-url/<block_id>/` | Создаёт публичный `slug` для блока. Тело: `{ "slug": "имя" }`. Slug должен содержать только буквы, цифры, дефисы и подчёркивания, длина от 1 до 100 символов. |
| `GET` | `/api/v1/check-url/<slug>/` | Проверяет доступность slug. Ответ: `{ "status": "available" \| "unavailable" }`. |
| `GET` | `/api/v1/get-urls/<block_id>/` | Возвращает список slug'ов, привязанных к блоку. |
| `DELETE` | `/api/v1/delete-url/<block_id>/<slug>/` | Удаляет slug (нужны права `delete`). |
| `POST` | `/api/v1/block/<slug>/` | Загружает структуру блока по slug. Требует JSON-тело с параметрами загрузки. Работает без аутентификации. |
| `POST` | `/api/v1/block/<slug>/nodes/` | Загружает дочерние узлы блока по slug. Требует `block_id` и `depth` в теле запроса. Блоки с правом `deny` исключаются из результата. |

## Управление группами
| Метод | URL | Описание |
|-------|-----|----------|
| `GET` | `/api/v1/groups/` | Список групп, владельцем которых является текущий пользователь. |
| `POST` | `/api/v1/groups/create/` | Создаёт группу. Тело: `{ "name": "..." }`. Владелец автоматически добавляется в участники. |
| `DELETE` | `/api/v1/groups/<group_id>/delete/` | Удаляет группу (только владелец). |
| `GET` | `/api/v1/groups/<group_id>/members/` | Возвращает список участников выбранной группы. |
| `POST` | `/api/v1/groups/<group_id>/add_member/` | Добавляет участника по `username`. |
| `DELETE` | `/api/v1/groups/<group_id>/remove_member/<username>` | Удаляет участника (нельзя исключить владельца). |

## История изменений
| Метод | URL | Описание |
|-------|-----|----------|
| `GET` | `/api/v1/blocks/<block_id>/history/` | Возвращает историю изменений блока. Требует аутентификации и права `view`, `edit`, `edit_ac` или `delete` на блок. |
| `POST` | `/api/v1/undo/` | Пытается откатить операцию. Требует аутентификации. Тело: `{ "operation": { "url": "edit-block/<uuid>/", "responseData": ... }, "force": false }`. Поддерживаются операции `new-tree`, `edit-block`, `new-block`, `create-link-block`, `copy-block`, `move-block`, `delete-tree`. |

### Структура данных для `POST /api/v1/import/`

Эндпойнт ожидает JSON-объект c единственным корневым полем `blocks`. Значение —
массив описаний блоков, которые нужно создать, обновить или синхронизировать.
Каждый элемент массива должен иметь следующую структуру:

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `id` | `UUID` | **Да** | Уникальный идентификатор блока. Используется как ключ при поиске существующей записи. |
| `title` | `string` | Нет | Заголовок блока. Если не передан, существующее значение сохраняется. Можно передавать пустую строку или `null`. |
| `data` | `object` | Нет | Произвольный JSON с пользовательскими данными. Поле `childOrder` (массив UUID детей) используется для сохранения порядка дочерних элементов. |
| `parent_id` | `UUID \| null` | Нет | Родитель блока. Если задан и отличается от текущего значения — блок будет перемещён. Несуществующий идентификатор не изменит родителя и попадёт в раздел `problem_blocks`. |
| `creator_id` | `integer \| null` | Нет | Пользователь, который будет записан создателем нового блока. Если поле отсутствует, используется авторизованный пользователь запроса. Если ни то, ни другое недоступно, создание блока будет пропущено, а в отчёт добавится ошибка `creator_missing`. |
| `links` | `UUID[]` | Нет | Список идентификаторов блоков, на которые должны вести ссылки (`BlockLink`). Допускается передавать как существующие в БД, так и импортируемые вместе с текущей партией блоки. |
| `permissions` | `object` | Нет | Описание прав доступа. См. подробности ниже. |
| `updated_at` | `string` (ISO 8601) | Нет | Отметка времени обновления блока. Если указана, перезапишет поле `updated_at` существующего блока. |

#### Поле `permissions`

Объект `permissions` может содержать два массива:

```json
{
  "permissions": {
    "users": [
      { "user_id": 42, "permission": "view" }
    ],
    "groups": [
      { "group_id": 7, "permission": "edit" }
    ]
  }
}
```

- `users` — список прав для конкретных пользователей. Допустимые значения
  `permission`: `"view"`, `"edit"`, `"deny"`.
- `groups` — аналогичный список для групп. При импорте права автоматически
  разворачиваются на всех текущих участников группы.

Если для нового блока не передано ни одного права, ему будет выдано право
`delete` (значение `DEFAULT_CREATOR_PERMISSION`) для пользователя из `creator_id`
или авторизованного пользователя запроса.

#### Линки (`links`)

Каждый идентификатор из массива `links` превращается в связь `source → target`
между импортируемым блоком и указанной целью. Ссылка создаётся или обновляется
даже если целевой блок не входит в текущую партию данных, при условии что он
существует в базе.

#### Обработка порядка детей (`childOrder`)

- При создании или перемещении блока он автоматически добавляется в конец
  списка `childOrder` родителя.
- Если блок переезжает к новому родителю, его идентификатор удаляется из
  `childOrder` старого родителя и добавляется к новому.
- Переданный в `data.childOrder` список заменяет порядок детей у родителя,
  но значения проверяются на существование — лишние идентификаторы игнорируются.

#### Валидаторы и отчёт

Ответ эндпойнта содержит статистику (`created`, `updated`, `unchanged`,
`permissions_upserted`, `links_upserted`) и массив `problem_blocks`. Каждый
элемент `problem_blocks` включает `block_id`, `code` и `message`. Возможные
коды: `creator_missing`, `parent_not_found`, `cycle_detected` и др., в зависимости
от выявленной проблемы.

Пример запроса:

```http
POST /api/v1/import/
Content-Type: application/json

{
  "blocks": [
    {
      "id": "2d0fd3cb-8c52-4368-b2b7-7bc9088940a0",
      "title": "Новая заметка",
      "data": {"childOrder": []},
      "parent_id": "0d3faae7-5d5a-4f2a-8ee8-0f0a7193088a",
      "links": ["bbf49b23-3cf4-4c3b-8ec8-ef1e6bb00ad7"],
      "permissions": {
        "users": [{"user_id": 5, "permission": "edit"}],
        "groups": [{"group_id": 3, "permission": "view"}]
      }
    }
  ]
}
```

### Структура данных для `POST /api/v1/export/`

Эндпойнт экспортирует блоки в формате, который можно напрямую передать в `/api/v1/import/`.

#### Параметры запроса

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `block_ids` | `UUID[]` | **Да** | Список UUID корневых блоков для экспорта. |
| `include_children` | `boolean` | Нет | Включать дочерние блоки рекурсивно (по умолчанию `true`). |
| `max_depth` | `integer` | Нет | Максимальная глубина экспорта (по умолчанию `LINK_LOAD_DEPTH_LIMIT`). |
| `include_permissions` | `boolean` | Нет | Включать права доступа в экспорт (по умолчанию `false`). |

#### Пример запроса

```http
POST /api/v1/export/
Content-Type: application/json

{
  "block_ids": ["2d0fd3cb-8c52-4368-b2b7-7bc9088940a0"],
  "include_children": true,
  "max_depth": 5,
  "include_permissions": true
}
```

#### Пример ответа

```json
{
  "blocks": [
    {
      "id": "2d0fd3cb-8c52-4368-b2b7-7bc9088940a0",
      "title": "Корневой блок",
      "data": {"childOrder": ["child-uuid-1", "child-uuid-2"]},
      "parent_id": null,
      "permissions": {
        "users": [
          {"user_id": 1, "permission": "delete"},
          {"user_id": 2, "permission": "view"}
        ]
      }
    },
    {
      "id": "child-uuid-1",
      "title": "Дочерний блок",
      "data": {"childOrder": []},
      "parent_id": "2d0fd3cb-8c52-4368-b2b7-7bc9088940a0"
    }
  ],
  "total": 2
}
```

#### Использование с import

Экспортированные данные можно напрямую импортировать:

```javascript
// Экспорт
const exportResponse = await fetch('/api/v1/export/', {
  method: 'POST',
  body: JSON.stringify({ block_ids: ['uuid1', 'uuid2'] })
});
const { blocks } = await exportResponse.json();

// Импорт в другое место (изменяем parent_id)
blocks.forEach(b => {
  if (b.parent_id === null) {
    b.parent_id = 'new-parent-uuid';
  }
});

await fetch('/api/v1/import/', {
  method: 'POST',
  body: JSON.stringify({ payload: blocks })
});
```

## Дополнительные замечания
- В ответах, где возвращаются данные блоков, используются сериализаторы `get_object_for_block`, `get_forest_serializer` и другие. Они приводят UUID к строкам и включают список дочерних блоков.
- Асинхронные уведомления об изменениях отправляются через Celery. Если метод возвращает `task_id`, актуальный статус можно получить через `/api/v1/tasks/<task_id>/`.
- Ограничения на глубину и количество блоков при загрузке/копировании задаются настройками `MAX_DEPTH_LOAD`, `LINK_LOAD_DEPTH_LIMIT`, `LIMIT_BLOCKS`.

