# OmniMap API

Документ описывает основные REST-эндпоинты проекта OmniMap. Все URL построены
относительно базового префикса `/api/v1/`.

## Базовые принципы
- **Формат данных:** все запросы и ответы используют JSON.
- **Аутентификация:** защищённые эндпоинты ожидают заголовок
  `Authorization: Bearer <JWT>`. JWT-токены выдаёт SimpleJWT.
- **Права доступа:** многие операции требуют определённых прав на блок. Если
  проверка не пройдена, API вернёт `403 Forbidden`.

## Аутентификация и пользователи
| Метод | URL | Описание |
|-------|-----|----------|
| `POST` | `/api/v1/register/` | Регистрирует пользователя и создаёт личный корневой блок. В ответе возвращаются пары токенов и идентификаторы пользователя/блока. |
| `POST` | `/api/v1/login/` | Получает пару JWT токенов (access/refresh). Требует `username` и `password`. |
| `POST` | `/api/v1/token/refresh/` | Обновляет access-токен по refresh-токену. |
| `POST` | `/api/v1/token/verify/` | Проверяет валидность access- или refresh-токена. |

## Работа с блоками и деревьями
| Метод | URL | Краткое описание | Важные параметры |
|-------|-----|------------------|------------------|
| `GET` | `/api/v1/load-trees/` | Загружает все доступные пользователю корневые деревья целиком. | Авторизованный пользователь определяется автоматически; для неавторизованных используется пользователь `main_page`. |
| `POST` | `/api/v1/load-empty/` | Возвращает «плоские» данные по указанным `block_ids` (список UUID). | Тело: `{ "block_ids": ["<uuid>", ...] }`. |
| `POST` | `/api/v1/new-tree/` | Создаёт новое корневое дерево (блок без родителя). | Тело: `{ "title": "Название" }`. |
| `POST` | `/api/v1/new-block/<parent_id>/` | Создаёт дочерний блок и наследует права родителя. | Тело: `{ "title": "...", "data": { ... } }`. Возвращает обновлённые данные дочернего и родительского блоков. |
| `POST` | `/api/v1/create-link-block/<parent_id>/<source_id>/` | Создаёт «линковый» блок, указывающий на существующий блок. | Тело пустое. В ответе — данные родителя, исходного блока и новой ссылки. |
| `POST` | `/api/v1/move-block/<old_parent_id>/<new_parent_id>/<child_id>/` | Перемещает блок в другое место дерева и обновляет порядок дочерних элементов. | Тело: `{ "childOrder": ["<uuid>", ...] }`. |
| `POST` | `/api/v1/edit-block/<block_id>/` | Обновляет заголовок и данные блока. | Тело может содержать `title` и/или `data`. Поле `source` в данных игнорируется. |
| `DELETE` | `/api/v1/delete-tree/<tree_id>/` | Удаляет дерево блоков целиком (учитываются права и наличие ссылок). | Без тела. Ответ содержит обновлённые данные родителя. |
| `DELETE` | `/api/v1/delete-tree-force/<tree_id>/` | Удаляет блок или дерево даже при наличии ссылок, переназначая их на служебный блок. | Требует права `delete`. |
| `POST` | `/api/v1/copy-block/` | Копирует одно или несколько поддеревьев в указанный блок-назначение. | Тело: `{ "dest": "<uuid>", "src": ["<uuid>", ...] }`. В ответе возвращается словарь новых блоков и ID их копий. |
| `POST` | `/api/v1/import/` | Массово создаёт/обновляет блоки. | Тело: `{ "blocks": [ { ... }, ... ] }`. Ответ содержит статистику по созданию/обновлению и списки проблемных блоков. |
| `GET` | `/api/v1/search-block/` | Поиск блоков, к которым у пользователя есть доступ. | Параметры: `q` (строка поиска), `root` (UUID корня для ограничения), `everywhere=true` для глобального поиска. Результат пагинирован (`page`, `page_size`). |

## Права доступа
| Метод | URL | Описание |
|-------|-----|----------|
| `GET` | `/api/v1/access/<block_id>/` | Возвращает список пользователей и групп с правами на блок. |
| `POST` | `/api/v1/access/<block_id>/` | Запускает асинхронное обновление прав. Тело: `{"permission_type": "<perm>", "target_username": "user"}` или `{"permission_type": "<perm>", "group_name": "group"}`. Ответ содержит `task_id`. |
| `GET` | `/api/v1/tasks/<task_id>/` | Проверяет статус Celery-задачи (например, изменения прав). Ответ: `{ "task_id": ..., "status": "PENDING|SUCCESS|...", "result": ... }`. |

## Общие ссылки (публичный доступ)
| Метод | URL | Описание |
|-------|-----|----------|
| `POST` | `/api/v1/create-url/<block_id>/` | Создаёт публичный `slug` для блока. Тело: `{ "slug": "имя" }`. |
| `GET` | `/api/v1/check-url/<slug>/` | Проверяет доступность slug. Ответ: `{ "status": "available" \| "unavailable" }`. |
| `GET` | `/api/v1/get-urls/<block_id>/` | Возвращает список slug'ов, привязанных к блоку. |
| `DELETE` | `/api/v1/delete-url/<block_id>/<slug>/` | Удаляет slug (нужны права `delete`). |
| `GET` | `/api/v1/block/<slug>/` | Возвращает структуру блока по slug без аутентификации и подписывает клиента на обновления. |

## Управление группами
| Метод | URL | Описание |
|-------|-----|----------|
| `GET` | `/api/v1/groups/` | Список групп, владельцем которых является текущий пользователь. |
| `POST` | `/api/v1/groups/create/` | Создаёт группу. Тело: `{ "name": "..." }`. Владелец автоматически добавляется в участники. |
| `DELETE` | `/api/v1/groups/<group_id>/delete/` | Удаляет группу (только владелец). |
| `GET` | `/api/v1/groups/<group_id>/members/` | Возвращает список участников выбранной группы. |
| `POST` | `/api/v1/groups/<group_id>/add_member/` | Добавляет участника по `username`. |
| `DELETE` | `/api/v1/groups/<group_id>/remove_member/<username>` | Удаляет участника (нельзя исключить владельца). |

## История изменений
| Метод | URL | Описание |
|-------|-----|----------|
| `GET` | `/api/v1/blocks/<block_id>/history/` | Возвращает историю изменений блока (список записей с автором, датой, типом операции). |
| `POST` | `/api/v1/undo/` | Пытается откатить операцию. Тело: `{ "operation": { "url": "edit-block/<uuid>/", "responseData": ... }, "force": false }`. Поддерживаются операции `new-tree`, `edit-block`, `new-block`, `create-link-block`, `copy-block`, `move-block`, `delete-tree`. |

## Дополнительные замечания
- В ответах, где возвращаются данные блоков, используются сериализаторы `get_object_for_block`, `get_forest_serializer` и другие. Они приводят UUID к строкам и включают список дочерних блоков.
- Асинхронные уведомления об изменениях отправляются через Celery. Если метод возвращает `task_id`, актуальный статус можно получить через `/api/v1/tasks/<task_id>/`.
- Ограничения на глубину и количество блоков при загрузке/копировании задаются настройками `MAX_DEPTH_LOAD`, `LINK_LOAD_DEPTH_LIMIT`, `LIMIT_BLOCKS`.

